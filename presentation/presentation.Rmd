---
title: "Exploring the Factors of Song Popularity"
subtitle: "Using TidyTuesdays Spotify dataset"
author: "Louhavidandros <br> Alexandros Zoupos, David Aiton, Harry Rushworth and Louis Parker"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(here)
library(patchwork)
library(ggridges)
```

```{r setup, include = FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include = FALSE}
spotify_songs <- readr::read_csv(here('data/Spotify.csv'))
```

```{r clean-data, include = FALSE}
clean_songs <- spotify_songs %>%
  filter(duplicated(track_name) == FALSE)

clean_full <- spotify_songs %>%
  group_by(playlist_genre) %>%
  filter(duplicated(track_name) == FALSE)
```

```{r popularity-level-clean-data, include = FALSE}
clean_edm <- clean_full %>%
  filter(playlist_genre == "edm") %>%
  mutate(popularity_level = case_when(
    track_popularity <= 17 ~ "Very Low",
    track_popularity > 17 & track_popularity <= 35 ~ "Low",
    track_popularity > 35 & track_popularity < 49 ~ "Fairly High",
    track_popularity >= 49 & track_popularity <= 100 ~ "High"
  ))

clean_latin <- clean_full %>%
  filter(playlist_genre == "latin") %>%
  mutate(popularity_level = case_when(
    track_popularity <= 31 ~ "Very Low",
    track_popularity > 31 & track_popularity <= 48 ~ "Low",
    track_popularity > 48 & track_popularity < 63 ~ "Fairly High",
    track_popularity >= 63 & track_popularity <= 100 ~ "High"
  ))

clean_rnb <- clean_full %>%
  filter(playlist_genre == "r&b") %>%
  mutate(popularity_level = case_when(
    track_popularity <= 21 ~ "Very Low",
    track_popularity > 21 & track_popularity <= 43 ~ "Low",
    track_popularity > 43 & track_popularity < 61 ~ "Fairly High",
    track_popularity >= 61 & track_popularity <= 100 ~ "High"
  ))

clean_rap <- clean_full %>%
  filter(playlist_genre == "rap") %>%
  mutate(popularity_level = case_when(
    track_popularity <= 30 ~ "Very Low",
    track_popularity > 30 & track_popularity <= 47 ~ "Low",
    track_popularity > 47 & track_popularity < 59 ~ "Fairly High",
    track_popularity >= 59 & track_popularity <= 100 ~ "High"
  ))

clean_pop <- clean_full %>%
  filter(playlist_genre == "pop") %>%
  mutate(popularity_level = case_when(
    track_popularity <= 30 ~ "Very Low",
    track_popularity > 30 & track_popularity <= 50 ~ "Low",
    track_popularity > 50 & track_popularity < 65 ~ "Fairly High",
    track_popularity >= 65 & track_popularity <= 100 ~ "High"
  )) 

clean_rock <- clean_full %>%
  filter(playlist_genre == "rock") %>%
  mutate(popularity_level = case_when(
    track_popularity <= 24 ~ "Very Low",
    track_popularity > 24 & track_popularity <= 45 ~ "Low",
    track_popularity > 45 & track_popularity < 61 ~ "Fairly High",
    track_popularity >= 61 & track_popularity <= 100 ~ "High"
  )) 

songs_ridges <- rbind(clean_rock, clean_rnb, clean_rap, clean_pop, clean_latin, clean_edm)
```

class: center, middle

## A statement of the overall goal / research question

class: inverse, center, middle

# Section title

---

```{r messy-plot, echo = FALSE, message=FALSE}
clean_songs %>%
ggplot(aes(x = speechiness, y = track_popularity)) +
geom_point() +
geom_smooth() +
labs(x = "Speechiness",
y = "Track popularity",
title = "Track popularity vs speechiness") +
theme_minimal() +
scale_color_viridis_d()
```

- Over 23,000 observations
---


```{r data-split, echo = FALSE}
set.seed(666)
clean_songs_split <- initial_split(clean_songs)
spotify_train <- training(clean_songs_split)
spotify_test <- testing(clean_songs_split)
```

```{r linear-mod, echo = FALSE}
songs_linear_mod <- linear_reg() %>%
  set_engine("lm")
```

```{r songs-recipe, echo = FALSE}
songs_rec <- recipe(track_popularity ~ ., data = clean_songs) %>%
  update_role(track_name, new_role = "ID") %>%
  update_role(track_artist, new_role = "Artist") %>%
  step_rm(track_id,track_album_id,track_album_name,track_album_release_date,playlist_name,playlist_id,playlist_subgenre) %>%
  step_dummy(all_nominal(), -c(track_name,track_artist)) %>%
  step_zv(all_predictors())
```

```{r workflow, echo = FALSE}
songs_wflow <- workflow() %>%
  add_model(songs_linear_mod) %>%
  add_recipe(songs_rec)
```

```{r fit-for-training, echo = FALSE}
songs_fit <- songs_wflow %>%
  fit(data = spotify_train)
```
Track popularity predicted by model vs actual track popularity

```{r pred-testing, echo = FALSE}
songs_test_pred <- predict(songs_fit, new_data = spotify_test) %>%
  bind_cols(spotify_test %>% select(track_popularity, track_name, track_artist))

kable(head(songs_test_pred), format = "html")
```

R squared (rsq) and root mean square error (rmse) of model

```{r rsq-rmse, echo = FALSE}
rsquared <- rsq(songs_test_pred, truth = track_popularity, estimate = .pred)

kable(head(rsquared), format = "html")

rmse <- rmse(songs_test_pred, truth = track_popularity, estimate = .pred)

kable(head(rmse), format = "html")
```

---
# Limitations

- Limited number of songs, only 32,833 songs were in the data set

--


- `track_popularity` variable does not take into account the popularity that songs had at the time they were released

--


- Only a linear model between the `track_popularity` and the other variables was tried

--


- Some songs may have been categorized in the wrong genre
---

# Popularity Level

- A new approach was taken by first finding the quartile values for every genre, and then categorising every song's popularity as either "High", "Fairly High", "Low", or "Very Low" depending on which quartile it fell into.

```{r quartile-example, echo = FALSE, message = FALSE}
quartile_table <- clean_full %>%
  group_by(playlist_genre) %>%
  summarise(quartiles = quantile(track_popularity))

kable(head(quartile_table), format = "html")
```

---

# Danceability Density Plot - Pop
- Optimal Range = range of danceability values where the red line is higher than the blue
```{r density-plot-example, echo = FALSE}
clean_pop %>%
    filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = danceability, color = popularity_level)) +
  geom_density(adjust = 2) +
    labs(x = "Danceability",
       y = "Frequency",
       color = "Popularity Level") +
  theme_minimal()
```

---

# Danceability Ridge Plot
```{r ridge-plot-example, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = danceability, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 0.045) +
  labs(x = "Danceability",
       y = NULL,
       fill = "Popularity Level",
       title = "Distibution of Danceability Across Genres",
       subtitle = "Grouped by Most and Least Popular Songs"
  ) + guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```
- EDM: negligible impact
- Rock, Rap, Pop, Latin: High danceability more likely to be popular
- R&B: Highest likelihood of popularity in lower optimal range
---

# Valence Ridge Plot
```{r valence-ridge, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = valence, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 0.085) +
  labs(x = "Valence",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```
---
# Energy Ridge Plot

```{r energy-ridges, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = energy, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 0.07) +
  labs(x = "Energy",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()

```
---

# Speechiness Ridge Plot

```{r speechiness-ridge, echo = FALSE}
songs_ridges  %>%
filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = speechiness, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 0.04) +
  labs(x = "Speechiness",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```
---

# Acousticness Ridge Plot

```{r acousticness-ridge, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = acousticness, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 0.05) +
  labs(x = "Acousticness",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```
---

# Liveness Ridge Plot

```{r liveness-ridge, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = liveness, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 0.045) +
  labs(x = "Liveness",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```
---

# Tempo Ridge Plot

```{r tempo-ridge, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = tempo, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 10) +
  labs(x = "Tempo (Bpm)",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```
---

# Duration Ridge Plot

```{r duration-ridge, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  group_by(popularity_level) %>%
  ggplot(aes(x = duration_ms/1000, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
  geom_density_ridges(alpha = 0.2, bandwidth = 20) +
  labs(x = "Duration (s)",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```
---

# Instrumentalness Ridge Plot

```{r instrumentalness-ridge, echo = FALSE}
songs_ridges %>%
  filter(popularity_level %in% c("High", "Very Low")) %>%
  ggplot(aes(x = instrumentalness, y = playlist_genre, fill = popularity_level, color = popularity_level)) +
   geom_density_ridges(alpha = 0.2, bandwidth = 0.06) +
  labs(x = "Instrumentalness",
       y = NULL,
       fill = "Popularity Level"
       ) +
  guides(color = FALSE) +
  scale_fill_manual(values = c(
    "Very Low" = "#008dfd",
    "High" = "#fd0000"
  )) +
  theme_minimal()
```


# Multiple Variable Analysis

```{r pop-multiple-variable-analysis-1, echo = FALSE}
mvg_pop <- clean_pop %>%
  mutate(dance_energy_val = danceability*energy*valence) %>%
  ggplot(aes(x = popularity_level, y = dance_energy_val, colour = popularity_level)) +
  geom_col() +
  labs(
    title = "Pop",
    y = "Count",
    x = "Popularity Level") +
  theme(legend.position = "none")

mvg_edm <- clean_edm %>%
  mutate(dance_energy_val = danceability*energy*valence) %>%
  ggplot(aes(x = popularity_level, y = dance_energy_val, colour = popularity_level)) +
  geom_col() +
  labs(
    title = "EDM",
    y = "Count",
    x = "Popularity Level") +
  theme(legend.position = "none")

mvg_rap <- clean_rap %>%
  mutate(dance_energy_val = danceability*energy*valence) %>%
  ggplot(aes(x = popularity_level, y = dance_energy_val, colour = popularity_level)) +
  geom_col() +
  labs(
    title = "Rap",
    y = "Count",
    x = "Popularity Level") +
  theme(legend.position = "none")

mvg_rock <- clean_rock %>%
  mutate(dance_energy_val = danceability*energy*valence) %>%
  ggplot(aes(x = popularity_level,y = dance_energy_val, colour = popularity_level)) +
  geom_col() +
  labs(
    title = "Rock",
    y = "Count",
    x = "Popularity Level") +
  theme(legend.position = "none")
  

 (mvg_edm | mvg_rap)/(mvg_pop | mvg_rock)
```
---

# Multiple Variable analysis part 2

```{r multiple-variable-analysis-2, echo = FALSE}
mvg_latin <- clean_latin  %>%
  mutate(dance_energy_val = danceability*energy*valence) %>%
  ggplot(aes(x = popularity_level, y = dance_energy_val, colour = popularity_level)) +
  geom_col() +
  labs(
    title = "Latin",
    y = "Count",
    x = "Popularity Level") +
  theme(legend.position = "none")

mvg_rnb <- clean_rnb %>%
  mutate(dance_energy_val = danceability*energy*valence)  %>%
  ggplot(aes(x = popularity_level, y = dance_energy_val, colour = popularity_level)) +
  geom_col() +
  labs(
    title = "R&B",
    y = "Count",
    x = "Popularity Level") +
  theme(legend.position = "none")

mvg_rnb+mvg_latin
```

---

# Changes in Trends Over Time

```{r Timeline, echo=FALSE, message=FALSE}
songs_ridges %>%
  filter(popularity_level == "High") %>%
  mutate(track_album_release_year = as.integer(str_sub(track_album_release_date, end = 4))) %>%
  filter(track_album_release_year >= 1970) %>%
  group_by(track_album_release_year) %>%
  summarise(acousticness = mean(acousticness), danceability = mean(danceability), energy = mean(energy), liveness = mean(liveness), 
            speechiness = mean(speechiness), valence = mean(valence)) %>%
  pivot_longer(cols = c(danceability, energy, speechiness, acousticness,
         liveness, valence)) %>%
  ggplot(aes(x = track_album_release_year, y = value, colour = name)) +
  geom_point()+
  geom_smooth() +
  theme_minimal() +
  facet_wrap(~name) +
  labs(x = "Release year",
       y = "Value",
       colour = "Variables") +
theme(axis.text.x = element_text(angle=45, hjust = 1))
```

---
#The models for the variables
```{r create_summary_years, include = FALSE}
mean_year_songs <- songs_ridges %>%
  filter(popularity_level == "High") %>%
  mutate(track_album_release_year = as.integer(str_sub(track_album_release_date, end = 4)))%>%
  filter(track_album_release_year >= 1970) %>%
  select(track_album_release_year, track_popularity, danceability, energy, 
         speechiness, acousticness, instrumentalness, liveness) %>%
  group_by(track_album_release_year) %>%
  summarise(acousticness = mean(acousticness), danceability = mean(danceability), 
            energy = mean(energy), instrumentalness = mean(instrumentalness), 
            liveness = mean(liveness), speechiness = mean(speechiness), popularity = mean(track_popularity))
```

```{r models, echo = FALSE}
linear_reg() %>%
  set_engine("lm") %>%
  fit(danceability ~ track_album_release_year, data = mean_year_songs)
linear_reg() %>%
  set_engine("lm") %>%
  fit(danceability ~ track_album_release_year, data = mean_year_songs) %>%
  glance()
```

---
#The next best song of 2021

```{r, echo = FALSE}
model_table <- tibble(acousticness = 0.0874, danceability = 0.6767, 
                      energy = 0.7331, instrumentalness = 0.0097, liveness = 0.1967, valence = 0.8828)
kable(head(model_table), format = "html")
```

---
# Thank you for listening

You can find the slides of this presentation here: put link. 
---

class: inverse, middle, center

# Using xaringan

---

# xaringan

- The presentation is created using the `xaringan` package

- Use `---` to separate slides and `--` for incremental builds

--

- Like this

---

# Layouts

You can use plain text

- or bullet points

.pull-left[
or text in two columns $^*$
]
.pull-right[
- like
- this
]

.footnote[
[*] And add footnotes
]

---

# Code

```{r boring-regression}
# a boring regression
model <- lm(dist ~ speed, data = cars)
tidy(model)
glance(model)
```

---

# Plots

```{r recode-species, echo = FALSE}
# In this chunk I'm doing a bunch of analysis that I don't want to present 
# in my slides. But I need the resulting data frame for a plot I want to present.
iris_modified <- iris %>%
  mutate(Species = fct_other(Species, keep = "setosa"))
```

```{r plot-iris, echo = FALSE}
# Code hidden with echo = FALSE
# Uses modified iris dataset from previous chunk
# Play around with height and width until you're happy with the look
ggplot(data = iris_modified, mapping = aes(x = Sepal.Width, y = Sepal.Length, color = Species)) +
  geom_point() + 
  theme_minimal() # theme options: https://ggplot2.tidyverse.org/reference/ggtheme.html
```

---

## Plot and text

.pull-left[
- Some text
- goes here
]
.pull-right[
```{r warning=FALSE, out.width="100%", fig.width=4, echo=FALSE}
# see how I changed out.width and fig.width from defaults
# to make the figure bigger
ggplot(penguins, aes(x = bill_length_mm, y = species, color = species)) +
  geom_boxplot() +
  theme_minimal()
```
]

---

# Tables

If you want to generate a table, make sure it is in the HTML format (instead of Markdown or other formats), e.g.,

```{r iris-table, echo = FALSE}
kable(head(iris), format = "html")
```

---

# Images

```{r castle, echo = FALSE, out.width = "60%", fig.align = "center", fig.cap = "Image credit: Photo by JÃ¶rg Angeli on Unsplash."}
include_graphics("https://images.unsplash.com/photo-1535448033526-c0e85c9e6968?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1650&q=80")
```

Or you can also include a full page image. See next slide.

---

background-image: url(https://images.unsplash.com/photo-1535448033526-c0e85c9e6968?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1650&q=80)

---

# Math Expressions

You can write LaTeX math expressions inside a pair of dollar signs, e.g. &#36;\alpha+\beta$ renders $\alpha+\beta$. You can use the display style with double dollar signs:

```
$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$
```

$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$

Limitations:

1. The source code of a LaTeX math expression must be in one line, unless it is inside a pair of double dollar signs, in which case the starting `$$` must appear in the very beginning of a line, followed immediately by a non-space character, and the ending `$$` must be at the end of a line, led by a non-space character;

1. There should not be spaces after the opening `$` or before the closing `$`.

1. Math does not work on the title slide (see [#61](https://github.com/yihui/xaringan/issues/61) for a workaround).

---

# Feeling adventurous?

- Want to find out more about `xaringan`? See https://slides.yihui.name/xaringan/#1.

- You are welcomed to use the default styling of the slides. In fact, that's what I expect majority of you will do. You will differentiate yourself with the content of your presentation.

- But some of you might want to play around with slide styling. The 
`xaringanthemer` provides some solutions for this that: https://pkg.garrickadenbuie.com/xaringanthemer.

- And if you want more bells and whistles, there is also `xaringanExtra`: https://pkg.garrickadenbuie.com/xaringanExtra.
